#!/usr/bin/env bash

# Certux System Mechanic v1.1
# Purpose: Dynamically routes both web packages and local .deb files into the sandbox.

PACKAGE_INPUT=$1
CONTAINER_NAME="certux-legacy-layer"
BASE_IMAGE="debian:latest" 

if [ -z "$PACKAGE_INPUT" ]; then
    echo "Usage: cert-install <package_name> OR cert-install </path/to/file.deb>"
    exit 1
fi

echo "âš™ï¸  Initializing Certux Mechanic..."

# Check if the container exists. If not, create it.
if ! distrobox list | grep -q "$CONTAINER_NAME"; then
    echo "ðŸ“¦ Building isolated legacy environment..."
    distrobox create --name "$CONTAINER_NAME" --image "$BASE_IMAGE" --yes > /dev/null 2>&1
    distrobox enter "$CONTAINER_NAME" -- bash -c "sudo dpkg --add-architecture i386 && sudo apt-get update > /dev/null 2>&1"
fi

# ==========================================
# Phase 1: The Smart Detection Engine
# ==========================================
if [[ -f "$PACKAGE_INPUT" && "$PACKAGE_INPUT" == *.deb ]]; then
    # It is a local file. We must get the absolute path so the container can find it.
    FILE_PATH=$(realpath "$PACKAGE_INPUT")
    echo "ðŸ“¥ Local .deb detected. Installing inside sandbox..."
    
    # Install the physical file
    distrobox enter "$CONTAINER_NAME" -- bash -c "sudo apt-get update > /dev/null 2>&1 && sudo apt-get install -y '$FILE_PATH'"
    
    # Extract the REAL application name from the file metadata for the shortcut
    APP_NAME=$(distrobox enter "$CONTAINER_NAME" -- bash -c "dpkg-deb -f '$FILE_PATH' Package")
else
    # It is a web repository package
    echo "ðŸ“¥ Web package detected. Downloading and installing '$PACKAGE_INPUT'..."
    distrobox enter "$CONTAINER_NAME" -- bash -c "sudo apt-get update > /dev/null 2>&1 && sudo apt-get install -y $PACKAGE_INPUT"
    APP_NAME="$PACKAGE_INPUT"
fi

# ==========================================
# Phase 2: Host Integration
# ==========================================
echo "ðŸ”— Bridging '$APP_NAME' to the Certux interface..."
distrobox enter "$CONTAINER_NAME" -- bash -c "distrobox-export --app $APP_NAME"

echo "âœ… Success!"
