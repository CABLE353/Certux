#!/usr/bin/env bash

# Certux System Mechanic: cert-install
# Purpose: Intercepts package installations, routes them into a dedicated 
# legacy container, and dynamically exports the GUI shortcut to the host OS.

PACKAGE_NAME=$1
CONTAINER_NAME="certux-legacy-layer"
BASE_IMAGE="debian:latest" # Using Debian for maximum .deb compatibility

# 1. Input Validation
if [ -z "$PACKAGE_NAME" ]; then
    echo "Usage: cert-install <package_name>"
    echo "Example: cert-install vlc"
    exit 1
fi

echo "‚öôÔ∏è  Initializing Certux Mechanic for: $PACKAGE_NAME..."

# 2. Dynamic Base Image (DBI) Initialization
# Check if the container already exists. If not, create it silently.
if ! distrobox list | grep -q "$CONTAINER_NAME"; then
    echo "üì¶ Building isolated legacy environment ($CONTAINER_NAME)..."
    distrobox create --name "$CONTAINER_NAME" --image "$BASE_IMAGE" --yes > /dev/null 2>&1
    echo "‚úÖ Legacy environment initialized."
fi

# 3. Secure Installation
echo "üì• Installing '$PACKAGE_NAME' inside the sandbox..."
# Enter the container, update sources, and install the requested package
distrobox enter "$CONTAINER_NAME" -- bash -c "sudo apt-get update > /dev/null 2>&1 && sudo apt-get install -y $PACKAGE_NAME"

# Check if the installation succeeded
if [ $? -ne 0 ]; then
    echo "‚ùå Error: Failed to install $PACKAGE_NAME."
    exit 1
fi

# 4. Host Integration (The "Harmless Trickery")
echo "üîó Bridging application to the Certux interface..."
# Export the application so it appears in the host's app launcher, but runs in the container
distrobox enter "$CONTAINER_NAME" -- bash -c "distrobox-export --app $PACKAGE_NAME"

echo "‚úÖ Success! '$PACKAGE_NAME' is now securely installed."
echo "You can now launch it directly from your Certux app menu."
